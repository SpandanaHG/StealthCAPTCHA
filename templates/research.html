
{% extends "base.html" %}

{% block title %}Research Interface - StealthCAPTCHA{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-microscope me-2"></i>Research Interface</h2>
            <p class="lead text-muted">Interactive behavioral biometrics research platform for academic studies.</p>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Research Note:</strong> This system collects anonymous behavioral data for academic cybersecurity research.
            </div>
        </div>
    </div>
    
    <!-- Live Behavioral Analysis -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line me-2"></i>Live Behavioral Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h4 id="mouse-events" class="text-primary">0</h4>
                            <small>Mouse Events</small>
                        </div>
                        <div class="col-md-3">
                            <h4 id="click-events" class="text-success">0</h4>
                            <small>Click Events</small>
                        </div>
                        <div class="col-md-3">
                            <h4 id="keystroke-events" class="text-warning">0</h4>
                            <small>Keystroke Events</small>
                        </div>
                        <div class="col-md-3">
                            <h4 id="scroll-events" class="text-info">0</h4>
                            <small>Scroll Events</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Research Tasks -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-keyboard me-2"></i>Keystroke Analysis</h5>
                </div>
                <div class="card-body">
                    <form id="text-analysis-form">
                        <div class="mb-3">
                            <label for="research-text" class="form-label">Type the following text naturally:</label>
                            <textarea id="research-text" name="text" class="form-control" rows="3" 
                                placeholder="The quick brown fox jumps over the lazy dog. This sentence contains every letter of the alphabet at least once."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-brain me-2"></i>Analyze Typing Patterns
                        </button>
                    </form>
                    <div id="text-result" class="mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-mouse-pointer me-2"></i>Mouse Movement Analysis</h5>
                </div>
                <div class="card-body">
                    <form id="mouse-analysis-form">
                        <div class="mb-3">
                            <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; position: relative;">
                                <div class="target-dot" style="position: absolute; top: 20px; left: 20px; width: 20px; height: 20px; background: #dc3545; border-radius: 50%; cursor: pointer;"></div>
                                <div class="target-dot" style="position: absolute; bottom: 20px; left: 20px; width: 20px; height: 20px; background: #28a745; border-radius: 50%; cursor: pointer;"></div>
                                <div class="target-dot" style="position: absolute; top: 20px; right: 20px; width: 20px; height: 20px; background: #007bff; border-radius: 50%; cursor: pointer;"></div>
                                <div class="target-dot" style="position: absolute; bottom: 20px; right: 20px; width: 20px; height: 20px; background: #ffc107; border-radius: 50%; cursor: pointer;"></div>
                            </div>
                            <small class="text-muted">Click all colored dots to complete the task</small>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-crosshairs me-2"></i>Analyze Mouse Patterns
                        </button>
                    </form>
                    <div id="mouse-result" class="mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar me-2"></i>Detection Results</h5>
                </div>
                <div class="card-body">
                    <div id="no-detection" class="text-center text-muted">
                        <i class="fas fa-hourglass-half fa-2x mb-3"></i>
                        <p>Complete a research task to see detection results</p>
                    </div>
                    <div id="detection-result" style="display: none;">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Session ID for tracking
const sessionId = '{{ session_id }}';

// Tracking counters
let mouseEvents = 0;
let clickEvents = 0;
let keystrokeEvents = 0;
let scrollEvents = 0;
let targetsClicked = 0;
const totalTargets = 4;

// Enhanced behavioral tracking for research
function initResearchTracking() {
    document.addEventListener('mousemove', function(e) {
        mouseEvents++;
        updateCounters();
    });
    
    document.addEventListener('click', function(e) {
        clickEvents++;
        updateCounters();
        
        if (e.target.classList.contains('target-dot')) {
            e.target.style.background = '#6c757d';
            e.target.style.pointerEvents = 'none';
            targetsClicked++;
        }
    });
    
    document.addEventListener('keydown', function(e) {
        keystrokeEvents++;
        updateCounters();
    });
    
    document.addEventListener('scroll', function(e) {
        scrollEvents++;
        updateCounters();
    });
}

function updateCounters() {
    document.getElementById('mouse-events').textContent = mouseEvents;
    document.getElementById('click-events').textContent = clickEvents;
    document.getElementById('keystroke-events').textContent = keystrokeEvents;
    document.getElementById('scroll-events').textContent = scrollEvents;
}

function showResearchResult(result) {
    document.getElementById('no-detection').style.display = 'none';
    document.getElementById('detection-result').style.display = 'block';
    
    const resultDiv = document.getElementById('detection-result');
    resultDiv.innerHTML = `
        <div class="alert alert-${result.prediction === 'human' ? 'success' : 'danger'}">
            <h5>Detection Result: ${result.prediction.toUpperCase()}</h5>
            <p>Confidence: ${(result.confidence * 100).toFixed(1)}%</p>
            <p>Processing Time: ${result.processing_time_ms}ms</p>
        </div>
    `;
}

function submitResearchTask(taskType, actionType) {
    if (taskType === 'mouse' && targetsClicked < totalTargets) {
        alert('Please click all targets before submitting the task.');
        return;
    }

    const formData = {
        sessionId: sessionId,
        page_url: window.location.pathname,
        action_type: actionType
    };

    fetch('/api/detect_bot', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.prediction) {
            showResearchResult(data);
            
            const resultDiv = document.getElementById(taskType + '-result');
            if (resultDiv) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div class="alert alert-info">
                        <strong>Task Completed:</strong> ${data.prediction} detected with ${(data.confidence * 100).toFixed(1)}% confidence
                    </div>
                `;
            }
        } else if (data.error) {
            showResearchResult({
                prediction: 'Error',
                confidence: 0,
                processing_time_ms: 0
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during analysis. Please try again.');
    });
}

// Form event handlers
document.addEventListener('DOMContentLoaded', function() {
    initResearchTracking();
    
    document.getElementById('text-analysis-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitResearchTask('text', 'keystroke_analysis');
    });
    
    document.getElementById('mouse-analysis-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitResearchTask('mouse', 'mouse_analysis');
    });
});
</script>
{% endblock %}
